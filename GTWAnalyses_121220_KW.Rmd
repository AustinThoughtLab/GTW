---
title: "GTW Analyses"
author: "KWilliams"
date: "12/11/2020"
output: html_document
---

1. Load packages
```{r, echo = FALSE}
library(tidyverse)
library(nloptr) #needed in order to call lme4
library(lme4)
library(ggplot2)
library(reshape2)
library(ggpubr)
```

2. Read in the German language data
```{r}
#Note that 999 indicates missing data
d.g <- read.csv('german_12112019.csv')
d.g <- d.g %>%      
  select(-dob, -dot, -agedays, -agemonths, -monolingual, -comments, -X, -X.1, -X.2, -X.3, -X.4) %>% #remove unnecessary columns
  rename('response1' = 'response.1') %>%
  mutate(language = 'german')


#replace missing data and empty cells with NA
d.g[d.g == "999"] <- NA 
d.g[d.g == ""] <- NA

#aggregate response1 and response 2 columns
d.g <- d.g %>%
mutate(response = ifelse(is.na(response2) == T, response1, response2))
```

3. Read in the English language data
```{r}
#Note that 999 indicates missing data
d.e <- read.csv('data_austin121119.csv')
d.e <- d.e %>%
  #remove unnecessary columns
  select(-ID,-dob, -dot, -agedays, -monolingual, -site, -comments, -covered) %>%
  mutate(language = 'english')

#replace missing data and empty cells with NA
d.e[d.e == "999"] <- NA 
d.e[d.e == ""] <- NA

#aggregate response1 and respnse 2 columns
d.e <- d.e %>%
mutate(response = ifelse(is.na(response2) == T, response1, response2))
```

4. Combine German and English data and fix typos in data entry and re-code weekday (1-7 corresponds to Sun-Sat)
```{r}
d.all <- rbind(d.g, d.e) %>% 
  mutate(item = as.factor(item),
         item = recode_factor(item, 'morning ' = 'thismorning',
                                      'twodaysago' = 'beforeyesterday', 
                                      'dayokweek' = 'daysofweek',
                                      'last year' = 'lastyear',
                                      'twofromnow' = 'aftertomorrow',
                                      'twoago' = 'beforeyesterday',
                                      'inaday' = 'tomorrow',
                                      'dayago' = 'yesterday',
                                      'onedayfromnow' = 'tomorrow',
                                      'thisevening' = 'tonight'),
        language = as.factor(language),
        itemnum = as.factor(itemnum),
        exclude = replace_na(exclude, 0))

d.all$weekday <- ifelse(d.all$weekday == "1", 7, ifelse(d.all$weekday == "2", 1, ifelse(d.all$weekday == "3", 2, ifelse(d.all$weekday == "4", 3, ifelse(d.all$weekday == "5", 4, ifelse(d.all$weekday == "6", 5, ifelse(d.all$weekday == "7", 6, 999)))))))
        #the weekday function in excel codes everything as 1-7 from Sun-Sat so here I am just re-coding so the              variable levels match our calendar task (e.g., 1-7 from Mon-Sun)

#replace missing data with NA
d.all$weekday[d.all$weekday == "999"] <- NA 
```

5. Code all future time words
```{r}
future.words = c('aftertoday','aftertomorrow','dinner','nextbday','nextweek','nextyear','tomorrow','tonight') 
```

6. Code correct responses (to compare to correctr variable) [Is there an easier way to do this?!]
```{r}
d.all <- d.all %>%
  mutate(correctR = case_when(task == "calendar" & itemtype == "deictic" & item == "yesterday" ~ '3',
                              task == "calendar" & itemtype == "deictic" & item == "beforeyesterday" ~ '2',
                              task == "calendar" & itemtype == "deictic" & item == "tomorrow" ~ '5',
                              task == "calendar" & itemtype == "deictic" & item == "aftertomorrow" ~ '6',
                              task == "calendar" & itemtype == "verbal" & item == "aftertoday" ~ '1',
                              task == "calendar" & itemtype == "verbal" & item == "beforetoday" ~ '2',
                              task == "calendar" & itemtype == "verbal" & item == "daysofweek" ~ '1',
                              #assuming a 1 indicates that the child correctly identified all 7 days of the week
                              task == "calendar" & itemtype == "verbal" & item == "today" & weekday == "1" ~ "1",
                              task == "calendar" & itemtype == "verbal" & item == "today" & weekday == "2" ~ "2",
                              task == "calendar" & itemtype == "verbal" & item == "today" & weekday == "3" ~ "3",
                              task == "calendar" & itemtype == "verbal" & item == "today" & weekday == "4" ~ "4",
                              task == "calendar" & itemtype == "verbal" & item == "today" & weekday == "5" ~ "5",
                              task == "calendar" & itemtype == "verbal" & item == "today" & weekday == "6" ~ "6",
                              task == "calendar" & itemtype == "verbal" & item == "today" & weekday == "7" ~ "7",
                              #remember that weekday values range from 1-7 and correspond to days of the week (e.g.,                               Monday = 1, Tuesday = 2, etc.)
                              task == "calendar" & itemtype =="verbal" & item =="yesterday" & weekday == "1" ~ '7',
                              task == "calendar" & itemtype =="verbal" & item =="yesterday" & weekday == "2" ~ '1',
                              task == "calendar" & itemtype =="verbal" & item =="yesterday" & weekday == "3" ~ '2',
                              task == "calendar" & itemtype =="verbal" & item =="yesterday" & weekday == "4" ~ '3',
                              task == "calendar" & itemtype =="verbal" & item =="yesterday" & weekday == "5" ~ '4',
                              task == "calendar" & itemtype =="verbal" & item =="yesterday" & weekday == "6" ~ '5',
                              task == "calendar" & itemtype =="verbal" & item =="yesterday" & weekday == "7" ~ '6',
                              task == "calendar" & itemtype =="verbal" & item =="tomorrow" & weekday == "1" ~ '2',
                              task == "calendar" & itemtype =="verbal" & item =="tomorrow" & weekday == "2" ~ '3',
                              task == "calendar" & itemtype =="verbal" & item =="tomorrow" & weekday == "3" ~ '4',
                              task == "calendar" & itemtype =="verbal" & item =="tomorrow" & weekday == "4" ~ '5',
                              task == "calendar" & itemtype =="verbal" & item =="tomorrow" & weekday == "5" ~ '6',
                              task == "calendar" & itemtype =="verbal" & item =="tomorrow" & weekday == "6" ~ '7',
                              task == "calendar" & itemtype =="verbal" & item =="tomorrow" & weekday == "7" ~ '1',
                              task == "timeline" & linenum == "1" & item == "lastbday" ~ '1',
                              task == "timeline" & linenum == "1" & item == "breakfast" ~ '2',
                              task == "timeline" & linenum == "1" & item == "dinner" ~ '3', 
                              task == "timeline" & linenum == "1" & item == "nextbday" ~ '4',
                              task == "timeline" & linenum == "2" & item == "lastweek" ~ '1',
                              task == "timeline" & linenum == "2" & item == "thismorning" ~ '2',
                              task == "timeline" & linenum == "2" & item == "tonight" ~ '3',
                              task == "timeline" & linenum == "2" & item == "tomorrow" ~ '4',
                              task == "timeline" & linenum == "3" & item == "lastyear" ~ '1',
                              task == "timeline" & linenum == "3" & item == "yesterday" ~ '2',
                              task == "timeline" & linenum == "3" & item == "nextweek" ~ '3',
                              task == "timeline" & linenum == "3" & item == "nextyear" ~ '4',
                              task == "timeline" & linenum == "4" & item == "beforeyesterday" ~ '1',
                              task == "timeline" & linenum == "4" & item == "yesterday" ~ '2',
                              task == "timeline" & linenum == "4" & item == "tomorrow" ~ '3',
                              task == "timeline" & linenum == "4" & item == "aftertomorrow" ~ '4'))
##seems to match correctr variable that already exists in the data file with two exceptions: 'weekdays' is coded as 1 = correctly named all 7 days and 0 = incorrectly named all 7 days; and verbal 'beforetoday' and 'aftertoday' are coded as indicated on the paper coding sheet e.g., 1 or 0.
```

7. Exclusions, change format of variables from factors to numeric and vice versa, create new variables to code correct responses and deictic status of responses on both the calendar and timeline task
```{r}
d.all <- d.all %>%
  filter(exclude==0) %>%
  mutate(response = as.numeric(response),
         correctR = as.numeric(correctR),
         order = as.factor(order),
         agegroup = as.factor(agegroup),
         linenum = as.factor(linenum),
         #create variable and code whether the item was placed in the correct rank (timeline task) or box (calendar task)
         correct = ifelse(response == correctR, 1, 0),
         #create variable to quantify how far the rank/box placement was from the correct rank/box
         dist.error = correctR - response,
         #create variable ignoring the direction of the error
         dist.error.a = abs(dist.error),
         #create variable and code whether the item was placed in the future (diectic status of response)
         resp.stat = case_when(task=='timeline' & distfrommid > 0 ~ 1,
                                 task=='calendar' & response > 4 ~ 1,
                                 task=='verbal' & item == 'today' & response > correctR ~ 1, 
                               TRUE ~ 0), #"what day will it be yesterday/today/tomorrow etc. e.g., Wednesday would be coded as 3"
         #create variable and code whether the items correct placement is in the future
         item.stat = ifelse(item %in% future.words, 1, 0),
         #create variable and code whether the participant correctly placed the item in the past vs. future
         stat.correct = ifelse(item.stat == resp.stat, 1, 0))
```

8. Participant counts
```{r}
subs <- d.all %>%
  select(subjid, agegroup, language) %>%
  group_by(agegroup, language) %>%
  distinct
count.cond.subs <- subs %>%
  group_by(agegroup, language) %>%
  summarise(n=n(), .groups = "keep")

#Make sure these counts line up with what Katharine expects/has on record (e.g., only 4 usuable 7YO tested in English?)
```

9. Calendar task only 
```{r}
cal.d <- d.all %>%
  filter(task=="calendar" & itemtype=="deictic" & agegroup %in% c('4','5','6') & ageyears<7.0) %>% #filter only calendar items that are marked as deictic (verbal items not involved in the calendar task)
  select(-linelength,-distfrommid) %>%
  mutate(#response = ifelse(is.na(response2) == T, response1, response2), #this is redundant
         #response = as.numeric(response), #this is redundant 
         cor.first = ifelse(response1==correctR, 1, 0), #did they get it right on the first trial
         prox = ifelse(item %in% c('yesterday','tomorrow'),1,0), #yesterday and tomorrow coded as proximal terms
         prox = as.factor(prox))


cal.sum <- cal.d %>%
  mutate(item = factor(item, levels = c("beforeyesterday", "aftertomorrow","yesterday","tomorrow"))) %>% #for each word, how many kids got them right on the first try
   group_by(language, agegroup, item) %>%
  summarize(first.m = mean(cor.first, na.rm=T),     # % who put item in right box on first try
            sd.correct = sd(cor.first, na.rm=T),
            n = n(),
            se.correct = sd.correct/sqrt(n),
            deictic.m = mean(stat.correct), # % who got correct status (final answer)
            rank.m = mean(correct))  # right box (final answer)
```


Calendar task only: Frequency distribution of box placement for each time word
```{r}
#filter by language
cal.e <- cal.d %>%
  filter(language == "english") %>%
  mutate(item = factor(item, levels = c("beforeyesterday", "yesterday", "tomorrow", "aftertomorrow")))

cal.g <- cal.d %>%
  filter(language == "german") %>%
  mutate(item = factor(item, levels = c("beforeyesterday", "yesterday", "tomorrow", "aftertomorrow")))

#Frequency distributions of first response only

par(mfrow=c(1,1))
E <- ggplot(cal.e, aes(x=response1)) +
  geom_histogram(position = "identity", colour = "grey40", alpha = 0.2, binwidth = 1) +
  xlab("box placement") +
  ggtitle("English Speakers") +
  ylim(0, 30) +
  facet_grid(item ~ agegroup)

G <- ggplot(cal.g, aes(x=response1)) +
  geom_histogram(position ="identity", colour = "grey40", alpha = 0.2, binwidth = 1) +
  xlab("box placement") +
  ggtitle("German Speakers") +
  ylim(0, 30) +
  facet_grid(item ~ agegroup)

histograms <- ggarrange(E, G, 
          ncol = 1, nrow = 2)

ggsave(histograms, file= "BoxPlacementByItem.jpeg", width = 10, height = 12, dpi = 300)
```

Calendar Task: does language spoken or age (in years) predict successful placement of time words in the correct squares on the first try?
```{r}
cal.lm = glmer(cor.first ~ language*prox+ageyears*prox + (1|subjid), family='binomial', data=cal.d)
summary(cal.lm)
```

Calendar Task: does language spoken or age (in years) predict successful placement of time words in the past or the future?
```{r}
d.lm = glmer(stat.correct ~ language*prox+ageyears*prox + (1|subjid), family='binomial', data=cal.d)
summary(d.lm)
```

```{r}
#-language:prox:ageyears 
verbal <- d.all %>%
  filter(itemtype=="verbal" & agegroup %in% c('4','5') & item=="daysofweek") %>%
  group_by(language, item) %>%
  summarize(correct.m <- mean(correct))

### plot correct first placements (Did they give correct response first time)
ggplot(data=cal.sum, aes(x=agegroup, y=first.m, group=language, color=language)) +
  geom_line(aes(color=language))+
  geom_point() +
  ylab('prop correct') +
  ylim(0,1) +
  #geom_errorbar(aes(ymin=first.m-se.correct, ymax=first.m+se.correct), width=.2, position=position_dodge(.05)) +
facet_wrap( ~ item, nrow=2) 
```
```{r}
### plot correct status
ggplot(data=cal.sum, aes(x=agegroup, y=deictic.m, group=language, color=language)) +
  geom_line(aes(color=language))+
  geom_point() +
  ylab('prop correct') +
  ylim(0,1) +
  #geom_errorbar(aes(ymin=first.m-se.correct, ymax=first.m+se.correct), width=.2, position=position_dodge(.05)) +
  facet_wrap( ~ item, nrow=2) 
```

### if child places aftertomorrow in the correct location, how likely are they to also place tomorrow in the same location? 
```{r}

#create new data frame
cal.e <- cal.d %>%
  select (subjid, agegroup, item, correct)
#transpose item (i.e., transform from long to wide format)
cal.e.T <- reshape(cal.e, idvar = c("subjid", "agegroup"), timevar = "item", direction = "wide")



### not sure what this histogram is showing
#ggplot(cal.tomorrow, aes(x=both.correct)) +
  #geom_histogram(position = "identity", colour = "grey40", alpha = 0.2, binwidth = 1) +
  #xlab("both correct") +
  #facet_grid(language ~ agegroup)

### plot correct first placements (Did they give correct response first time)
#ggplot(data=tomorrow.sum, aes(x=agegroup, y=both.correct.m)) +
  #geom_line()+
  #geom_point() +
  #ylab('prop correct') +
  #ylim(0,1) +
  #geom_errorbar(aes(ymin=first.m-se.correct, ymax=first.m+se.correct), width=.2, position=position_dodge(.05)) +
#facet_wrap( ~ language, nrow=2) 
```

